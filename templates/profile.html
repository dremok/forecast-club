{% extends "base.html" %}

{% block title %}Profile - Forecast Club{% endblock %}

{% block content %}
<h1>Your Profile</h1>

<div class="card mb-4">
    <div class="flex flex-between flex-center">
        <div>
            <h2 class="mb-1">{{ user.display_name or user.email }}</h2>
            <p class="text-muted mb-0">{{ user.email }}</p>
        </div>
        <a href="/profile/edit" class="btn btn-secondary btn-sm">Edit</a>
    </div>
</div>

<!-- Stats overview -->
<div class="card mb-4">
    <h2>Your Stats</h2>
    <div class="prediction-stats" style="border-top: none; padding-top: 0;">
        <div class="stat">
            <span class="stat-value">{{ stats.total_forecasts }}</span>
            <span class="stat-label">Total forecasts</span>
        </div>
        <div class="stat">
            <span class="stat-value">{{ stats.resolved_forecasts }}</span>
            <span class="stat-label">Resolved</span>
        </div>
        <div class="stat">
            <span class="stat-value">
                {% if stats.average_brier_score is not none %}
                {{ "%.3f"|format(stats.average_brier_score) }}
                {% else %}
                â€”
                {% endif %}
            </span>
            <span class="stat-label">Avg Brier score</span>
        </div>
    </div>
</div>

<!-- Calibration chart -->
{% if calibration %}
<div class="card mb-4">
    <h2>Your Calibration</h2>
    <p class="text-muted mb-3">How well do your probabilities match reality?</p>

    <div class="calibration-chart">
        <svg viewBox="0 0 300 300" style="width: 100%; max-width: 300px; margin: 0 auto; display: block;">
            <!-- Grid -->
            <line x1="50" y1="250" x2="250" y2="250" stroke="#e5e7eb" stroke-width="1"/>
            <line x1="50" y1="50" x2="50" y2="250" stroke="#e5e7eb" stroke-width="1"/>

            <!-- Perfect calibration line -->
            <line x1="50" y1="250" x2="250" y2="50" stroke="#d1d5db" stroke-width="2" stroke-dasharray="5,5"/>

            <!-- Calibration points -->
            {% for bucket in calibration %}
            <circle
                cx="{{ 50 + (bucket.predicted_probability * 200) }}"
                cy="{{ 250 - (bucket.actual_frequency * 200) }}"
                r="{{ 4 + bucket.count }}"
                fill="#6366f1"
                opacity="0.7"
            />
            {% endfor %}

            <!-- Axis labels -->
            <text x="150" y="290" text-anchor="middle" font-size="12" fill="#6b7280">Your probability</text>
            <text x="20" y="150" text-anchor="middle" font-size="12" fill="#6b7280" transform="rotate(-90, 20, 150)">Actual frequency</text>

            <!-- Tick labels -->
            <text x="50" y="270" text-anchor="middle" font-size="10" fill="#9ca3af">0%</text>
            <text x="150" y="270" text-anchor="middle" font-size="10" fill="#9ca3af">50%</text>
            <text x="250" y="270" text-anchor="middle" font-size="10" fill="#9ca3af">100%</text>
            <text x="40" y="254" text-anchor="end" font-size="10" fill="#9ca3af">0%</text>
            <text x="40" y="154" text-anchor="end" font-size="10" fill="#9ca3af">50%</text>
            <text x="40" y="54" text-anchor="end" font-size="10" fill="#9ca3af">100%</text>
        </svg>
    </div>

    <p class="text-muted text-center mt-3" style="font-size: 0.75rem;">
        Perfect calibration = points on the diagonal line. Circle size = number of forecasts.
    </p>
</div>
{% endif %}

<!-- Groups -->
<div class="card mb-4">
    <div class="flex flex-between flex-center mb-3">
        <h2 class="mb-0">Your Groups</h2>
        <a href="/groups/new" class="btn btn-secondary btn-sm">+ New group</a>
    </div>

    {% if groups %}
    <ul style="list-style: none;">
        {% for membership in groups %}
        <li class="flex flex-between flex-center" style="padding: 8px 0; border-bottom: 1px solid var(--gray-100);">
            <span>{{ membership.group.name }}</span>
            <span class="badge {% if membership.role.value == 'admin' %}badge-open{% else %}badge-ambiguous{% endif %}">
                {{ membership.role.value }}
            </span>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">No groups yet.</p>
    {% endif %}

    <p class="mt-3">
        <a href="/groups/join">Join a group with invite code</a>
    </p>
</div>

<!-- Logout -->
<div class="text-center mt-4">
    <a href="/logout" class="text-muted">Log out</a>
</div>
{% endblock %}
